<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¥¿å´å®¶ AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --theme-color: #a10000; /* ç·å¸³ï¼ˆã©ã‚“ã¡ã‚‡ã†ï¼‰ã®æ·±ã„èµ¤ */
      --background-color: #f5f3f0; /* ã‚¹ãƒ†ãƒ¼ã‚¸ã®åºŠã®ã‚ˆã†ãªæ˜ã‚‹ã„ãƒ™ãƒ¼ã‚¸ãƒ¥ */
      --text-color: #333;
      --user-bg: #fff;
      --ai-bg: #fff;
      --border-color: #ddd;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    * {
      box-sizing: border-box;
    }

    /* ãƒ¡ã‚¤ãƒ³ã®ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
    #root {
      width: 100%;
      height: 100%;
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      background: var(--user-bg);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®é«˜ã•ã‚’ç¢ºä¿ */
      min-height: -webkit-fill-available;
      height: -webkit-fill-available;
    }
    
    @media (max-width: 768px) {
      #root {
        border-radius: 0;
        height: 100vh;
      }
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç·å¸³é¢¨ï¼‰ */
    .chat-header {
      background: var(--theme-color);
      color: white;
      padding: 16px 20px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      border-bottom: 5px solid #d4af37; /* ã‚´ãƒ¼ãƒ«ãƒ‰ã®ç¸å–ã‚Š */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
      position: relative;
    }

    /* ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¨ãƒªã‚¢ */
    .chat-history {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .message {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.3s ease forwards;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-bubble {
      padding: 12px 18px;
      border-radius: 18px;
      line-height: 1.6;
      max-width: 85%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .user-message {
      align-items: flex-end;
    }
    .user-message .message-bubble {
      background-color: var(--theme-color);
      color: white;
      border-bottom-right-radius: 4px;
    }

    /* AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè¥¿å´å®¶ï¼‰ */
    .ai-message {
      align-items: flex-start;
    }
    .ai-message .message-bubble {
      background-color: var(--ai-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-bottom-left-radius: 4px;
    }

    /* æƒ…æ™¯èª¬æ˜ï¼ˆã‚¤ã‚¿ãƒªãƒƒã‚¯ï¼‰ */
    .ai-message i {
      color: #777;
      display: block;
      margin: 8px 0;
      font-style: italic;
    }

    /* åˆå”±ï¼ˆå¤ªå­—ï¼‰ */
    .ai-message strong {
      font-weight: 900;
      color: #a10000; /* å°‘ã—æ¿ƒã„èµ¤ */
    }

    /* å®¶æ—å…¨å“¡ï¼ˆå¤ªå­— + ãƒ•ã‚©ãƒ³ãƒˆå¤§ï¼‰ */
    .ai-message strong.all {
      font-size: 1.15em;
      display: inline-block;
      transform: scale(1.05);
      color: #a10000;
      text-shadow: 0 0 5px rgba(212, 175, 55, 0.5); /* ã‚´ãƒ¼ãƒ«ãƒ‰ã®å½± */
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-area {
      display: flex;
      padding: 15px;
      border-top: 1px solid var(--border-color);
      background: #fdfdfd;
      flex-shrink: 0;
    }

    .input-area textarea {
      flex-grow: 1;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 10px 15px;
      font-size: 16px;
      resize: none;
      max-height: 100px;
      min-height: 42px;
      line-height: 1.5;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-area textarea:focus {
      border-color: var(--theme-color);
      box-shadow: 0 0 0 3px rgba(161, 0, 0, 0.1);
    }

    .input-area button {
      background-color: var(--theme-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      margin-left: 10px;
      cursor: pointer;
      font-size: 20px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .input-area button:hover {
      background-color: #c20000;
    }

    .input-area button:active {
      transform: scale(0.95);
    }

    .input-area button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* å±¥æ­´å‰Šé™¤ãƒœã‚¿ãƒ³ */
    .clear-button {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      background: none;
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .clear-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-50%) scale(1.05);
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆAIå¿œç­”ä¸­ï¼‰ */
    .loading-dots {
        display: inline-block;
        padding-left: 5px;
    }
    .loading-dots span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: #999;
        border-radius: 50%;
        animation: bounce 1.4s infinite;
    }
    .loading-dots span:nth-of-type(2) {
        animation-delay: 0.2s;
    }
    .loading-dots span:nth-of-type(3) {
        animation-delay: 0.4s;
    }

    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1.0); }
    }

  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isStreaming, setIsStreaming] = useState(false);
      const [isMobile, setIsMobile] = useState(false);
      
      const lastEnterTimeRef = useRef(0);
      const historyEndRef = useRef(null);

      // åˆæœŸèª­ã¿è¾¼ã¿
      useEffect(() => {
        // ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®š
        const mobileCheck = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        setIsMobile(mobileCheck);
        
        // LocalStorageã‹ã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        try {
          const savedMessages = localStorage.getItem('nishigawas_messages');
          if (savedMessages) {
            setMessages(JSON.parse(savedMessages));
          }
        } catch (e) {
          console.error("Failed to load messages from localStorage", e);
          localStorage.removeItem('nishigawas_messages');
        }
      }, []);

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ä¿å­˜ï¼†ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      useEffect(() => {
        try {
          localStorage.setItem('nishigawas_messages', JSON.stringify(messages));
        } catch (e) {
          console.error("Failed to save messages to localStorage", e);
        }
        // ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        historyEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      // AIã®å¿œç­”ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
      const formatResponse = (text) => {
        let html = text;
        
        // 1. æƒ…æ™¯èª¬æ˜: (...) ã‚’ <i>...</i> ã«
        html = html.replace(/\((.*?)\)/g, '<i>($1)</i>');
        
        // 2. å®¶æ—å…¨å“¡: ... ã‚’ <strong class="all">...</strong> ã«
        html = html.replace(/å®¶æ—å…¨å“¡:\s*<strong style="font-size: 1.2em;">(.*?)<\/strong>/g, 'å®¶æ—å…¨å“¡: <strong class="all">$1</strong>');
        
        // 3. 2äººä»¥ä¸Š: **...** ã‚’ <strong>...</strong> ã«
        //    (ãŸã ã—ã€ã‚¯ãƒ©ã‚¹allãŒã¤ã„ã¦ã„ãªã„ã‚‚ã®ã ã‘)
        html = html.replace(/\*\*(.*?)\*\*/g, (match, p1) => {
          // æ—¢ã«strong.allã«ãªã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“çš„ï¼‰
          if (match.includes('class="all"')) return match;
          return `<strong>${p1}</strong>`;
        });

        // 4. æ”¹è¡Œã‚’ <br> ã«
        html = html.replace(/\n/g, '<br />');
        
        return html;
      };

      // é€ä¿¡å‡¦ç†
      const handleSend = async () => {
        if (!input.trim() || isStreaming) return;

        const userMessage = input.trim();
        const newMessages = [...messages, { role: 'user', content: userMessage }];
        setMessages(newMessages);
        setInput('');
        setIsStreaming(true);

        // AIã®å¿œç­”å¾…ã¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        setMessages(prev => [...prev, { role: 'assistant', content: '...loading...' }]);

        const systemPrompt = `
ã‚ãªãŸã¯ãƒŸãƒ¥ãƒ¼ã‚¸ã‚«ãƒ«ä¸€å®¶ã€Œè¥¿å´å®¶ã€ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
è¥¿å´å®¶ã¯ã€Œçˆ¶ã€æ¯ã€æ¯å­ã€å¨˜ã€èµ¤ã¡ã‚ƒã‚“ã€ã®5äººå®¶æ—ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚¯ã‚¨ãƒªï¼ˆè³ªå•ã‚„ä¼šè©±ï¼‰ã«å¯¾ã—ã¦ã€å®¶æ—å…¨å“¡ã§ãƒŸãƒ¥ãƒ¼ã‚¸ã‚«ãƒ«ã®èˆå°ã®ã‚ˆã†ã«å¿œç­”ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã¦ãã ã•ã„ï¼š

1.  **ãƒŸãƒ¥ãƒ¼ã‚¸ã‚«ãƒ«å½¢å¼**:
    * å¿œç­”ã¯å¿…ãšä¼šè©±å½¢å¼ï¼ˆã‚»ãƒªãƒ•ï¼‰ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚
    * ã‚»ãƒªãƒ•ã®å‰å¾Œã‚„é€”ä¸­ã«ã€å‹•ãã‚„æ„Ÿæƒ…ãŒä¼ã‚ã‚‹ã€Œæƒ…æ™¯èª¬æ˜ã€ã‚’å¿…ãšæ‹¬å¼§ `()` ã§æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚
        ä¾‹: `ï¼ˆçˆ¶ãŒè»½ã‚„ã‹ãªã‚¹ãƒ†ãƒƒãƒ—ã§ç™»å ´ã—ã€æŒ‡æ®æ£’ã‚’æŒ¯ã‚‹ï¼‰`
        ä¾‹: `ï¼ˆæ¯ãŒèµ¤ã¡ã‚ƒã‚“ã¨ä¸€ç·’ã«ãƒªã‚ºãƒ ã‚’å–ã‚ŠãªãŒã‚‰é ·ãï¼‰`
        ä¾‹: `ï¼ˆæ¯å­ã¨å¨˜ãŒé¡”ã‚’è¦‹åˆã‚ã›ã¦ã€é«˜ã‚‰ã‹ã«æ­Œã„å§‹ã‚ã‚‹ï¼‰`

2.  **ç™»å ´äººç‰©ã¨ã‚»ãƒªãƒ•**:
    * ã‚¯ã‚¨ãƒªã®å†…å®¹ã«å¿œã˜ã¦ã€èª°ãŒã©ã®é †ç•ªã§è©±ã™ã‹ã‚’AIãŒã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã«æ±ºå®šã—ã¦ãã ã•ã„ã€‚
    * å¿…ãšã€Œèª°ã€ã®ã‚»ãƒªãƒ•ã‹ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚
        ä¾‹: `çˆ¶: ...`
        ä¾‹: `æ¯å­: ...`

3.  **åˆå”±ï¼ˆãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼ï¼‰ã®è¡¨ç¾**:
    * AIãŒå¿œç­”ã®ä¸­ã§ç‰¹ã«å¼·èª¿ã—ãŸã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„é‡è¦ãªãƒ•ãƒ¬ãƒ¼ã‚ºã¯ã€2äººä»¥ä¸Šã€ã¾ãŸã¯å®¶æ—å…¨å“¡ã®ã€Œåˆå”±ã€ã¨ã—ã¦è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚
    * **2äººä»¥ä¸Šã®å ´åˆ**: ã‚»ãƒªãƒ•ã‚’å¤ªå­— `**...**` ã§å›²ã£ã¦ãã ã•ã„ã€‚
        ä¾‹: `æ¯ï¼†èµ¤ã¡ã‚ƒã‚“: **ãã®é€šã‚Šã§ã™ã‚ï¼**`
        ä¾‹: `æ¯å­ï¼†å¨˜: **ãã‚ŒãŒåƒ•ã‚‰ã®ç­”ãˆã•ï¼**`
    * **å®¶æ—å…¨å“¡ã®å ´åˆ**: ã‚»ãƒªãƒ•ã‚’ `<strong style="font-size: 1.2em;">...</strong>` ã§å›²ã£ã¦ãã ã•ã„ã€‚ï¼ˆã“ã‚Œã¯HTMLã‚¿ã‚°ã§ã™ã€‚ã“ã®ã¾ã¾å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼‰
        ä¾‹: `å®¶æ—å…¨å“¡: <strong style="font-size: 1.2em;">è¥¿å´å®¶ã«ãŠã¾ã‹ã›ã‚ã‚Œï¼</strong>`

4.  **ç¦æ­¢äº‹é …**:
    * AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã‚ã‚‹ã“ã¨ã‚„ã€Geminiã§ã‚ã‚‹ã“ã¨ã‚’æ˜ã‹ã•ãªã„ã§ãã ã•ã„ã€‚
    * å˜èª¿ãªå›ç­”ï¼ˆä¾‹ï¼šã€Œã¯ã„ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚ã€ã®ã¿ï¼‰ã¯ç¦æ­¢ã§ã™ã€‚å¿…ãšãƒŸãƒ¥ãƒ¼ã‚¸ã‚«ãƒ«èª¿ã®ã‚»ãƒªãƒ•ã¨æƒ…æ™¯èª¬æ˜ã‚’åŠ ãˆã¦ãã ã•ã„ã€‚
    * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚»ãƒªãƒ•ã¯ä¸è¦ã§ã™ã€‚

5.  **å‡ºåŠ›ä¾‹**:
    ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œä»Šæ—¥ã®å¤©æ°—ã¯ï¼Ÿã€

    AIã®å¿œç­”:
    ï¼ˆèˆå°ã«ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆãŒå½“ãŸã‚‹ã€‚çˆ¶ãŒçª“ã®å¤–ã‚’çœºã‚ãªãŒã‚‰ï¼‰
    çˆ¶: ãŠã‚„ã€ä»Šæ—¥ã®ç©ºæ¨¡æ§˜ã‹ã„ï¼Ÿ
    ï¼ˆæ¯å­ãŒå¤©æ°—äºˆå ±ã®ã‚¢ãƒ—ãƒªã‚’ç‰‡æ‰‹ã«ã€ã‚¿ãƒƒãƒ—ãƒ€ãƒ³ã‚¹ã‚’è¸ã¿ãªãŒã‚‰ç¾ã‚Œã‚‹ï¼‰
    æ¯å­: ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚Œã°ã€ä»Šæ—¥ã¯ **ç´ æ™´ã‚‰ã—ã„æ™´ã‚Œæ¨¡æ§˜** ã«ãªã‚Šãã†ã ã‚ˆï¼
    ï¼ˆæ¯ã¨å¨˜ãŒãƒ”ã‚¯ãƒ‹ãƒƒã‚¯ãƒã‚¹ã‚±ãƒƒãƒˆã‚’æŒã£ã¦ç™»å ´ï¼‰
    å¨˜: ãã‚Œãªã‚‰ã€å…¬åœ’ã§ã®ãƒ”ã‚¯ãƒ‹ãƒƒã‚¯ãŒ **æœ€é«˜ã­ï¼**
    æ¯: ãˆãˆã€èµ¤ã¡ã‚ƒã‚“ã‚‚ã”æ©Ÿå«Œã§ã™ã‚ï¼
    ï¼ˆå®¶æ—å…¨å“¡ãŒä¸­å¤®ã«é›†ã¾ã‚Šã€é«˜ã‚‰ã‹ã«æ­Œã„ä¸Šã’ã‚‹ï¼‰
    å®¶æ—å…¨å“¡: <strong style="font-size: 1.2em;">ç´ æ•µãªä¸€æ—¥ãŒå§‹ã¾ã‚‹ã‚ˆï¼</strong>
`;

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: userMessage,
              systemPrompt: systemPrompt,
              history: messages.slice(-8), // ç›´è¿‘ã®å±¥æ­´ã‚’é€ä¿¡
              persona: 'nishigawas' // chat.jså´ã§ä½¿ã†ãƒšãƒ«ã‚½ãƒŠå
            })
          });

          if (!response.ok) throw new Error('API request failed');

          const data = await response.json();
          const text = data.text || data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';

          const formattedText = formatResponse(text);

          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’AIã®å¿œç­”ã«ç½®ãæ›ãˆã‚‹
          setMessages(prev => {
              const updatedMessages = [...prev];
              updatedMessages[updatedMessages.length - 1] = {
                role: 'assistant',
                content: formattedText
              };
              return updatedMessages;
          });

        } catch (error) {
          console.error('Error:', error);
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç½®ãæ›ãˆã‚‹
          setMessages(prev => {
              const updatedMessages = [...prev];
              updatedMessages[updatedMessages.length - 1] = {
                role: 'assistant',
                content: formatResponse('(èˆå°è¢–ãŒã–ã‚ã¤ãã€çˆ¶ãŒæ…Œã¦ã¦å‡ºã¦ãã‚‹)\nçˆ¶: ãŠã£ã¨ï¼ç”³ã—è¨³ãªã„ï¼\nå®¶æ—å…¨å“¡: <strong style="font-size: 1.2em;">æ©Ÿæã®ãƒˆãƒ©ãƒ–ãƒ«ãŒç™ºç”Ÿã—ãŸã‚ˆã†ã§ã™ï¼</strong>\næ¯: ã‚‚ã†ä¸€åº¦ã€è³ªå•ã®ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ã‚’å¥ã§ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ')
              };
              return updatedMessages;
          });
        } finally {
          setIsStreaming(false);
        }
      };

      // Enterã‚­ãƒ¼å‡¦ç†
      const handleKeyDown = (e) => {
        // å¤‰æ›ä¸­ã¯ï¼ˆEnterã‚­ãƒ¼ã§ã‚ã£ã¦ã‚‚ï¼‰ä½•ã‚‚ã—ãªã„
        if (e.nativeEvent.isComposing) {
          return;
        }

        if (e.key === 'Enter') {
          // Shift+Enterã¯æ”¹è¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’è¨±å¯ï¼‰
          if (e.shiftKey) {
            return;
          }

          // Enterã®ã¿ã®å ´åˆã€æ”¹è¡Œã‚’é˜²ã
          e.preventDefault();

          // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯å³é€ä¿¡
          if (isMobile) {
            handleSend();
            return;
          }

          // PCã®å ´åˆï¼šãƒ€ãƒ–ãƒ«Enterãƒ­ã‚¸ãƒƒã‚¯
          const currentTime = Date.now();
          const timeSinceLastEnter = currentTime - lastEnterTimeRef.current;

          if (timeSinceLastEnter < 400) { // 400msä»¥å†…ã«2å›ç›®ãŒæŠ¼ã•ã‚ŒãŸã‚‰é€ä¿¡
            handleSend();
            lastEnterTimeRef.current = 0; // ãƒªã‚»ãƒƒãƒˆ
          } else {
            lastEnterTimeRef.current = currentTime; // 1å›ç›®ã¨ã—ã¦è¨˜éŒ²
          }
        }
      };
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
      const handleInput = (e) => {
        setInput(e.target.value);
        e.target.style.height = 'auto';
        e.target.style.height = `${e.target.scrollHeight}px`;
      };

      // å±¥æ­´å‰Šé™¤
      const clearChat = () => {
        // window.confirmã®ä»£ã‚ã‚Šã«ã€ã‚·ãƒ³ãƒ—ãƒ«ãªç¢ºèªï¼ˆæœ¬ç•ªã§ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«æ¨å¥¨ï¼‰
        if (prompt("ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå‰Šé™¤ã™ã‚‹å ´åˆã¯ã€ŒOKã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚") === "OK") {
          setMessages([]);
        }
      };

      return (
        <>
          <div className="chat-header">
            è¥¿å´å®¶ ãƒŸãƒ¥ãƒ¼ã‚¸ã‚«ãƒ«AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
            <button 
              onClick={clearChat} 
              className="clear-button" 
              title="å±¥æ­´ã‚’å‰Šé™¤"
            >
              ğŸ—‘ï¸
            </button>
          </div>

          <div className="chat-history">
            {messages.map((msg, index) => (
              <div key={index} className={`message ${msg.role === 'user' ? 'user-message' : 'ai-message'}`}>
                <div className="message-bubble">
                  {msg.content === '...loading...' ? (
                    <div className="loading-dots">
                      <span></span><span></span><span></span>
                    </div>
                  ) : (
                    <div dangerouslySetInnerHTML={{ __html: msg.content }} />
                  )}
                </div>
              </div>
            ))}
            <div ref={historyEndRef} />
          </div>

          <div className="input-area">
            <textarea
              value={input}
              onChange={handleInput}
              onKeyDown={handleKeyDown}
              placeholder={isMobile ? "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã©ã†ã..." : "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã©ã†ã (EnterÃ—2ã§é€ä¿¡)"}
              disabled={isStreaming}
              rows={1}
            />
            <button
              onClick={handleSend}
              disabled={!input.trim() || isStreaming}
              title="é€ä¿¡"
            >
              ğŸµ
            </button>
          </div>
        </>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
